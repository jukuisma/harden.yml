---
- name: Make installpkg store md5sums (Slackware)
  become: true
  when: ansible_distribution == "Slackware"
  ansible.builtin.replace:
    path: /sbin/installpkg
    regexp: '^(MD5SUM)=[0-9]+$'
    replace: '\g<1>=1'
    validate: '/bin/grep "^MD5SUM=1$" %s'
  tags:
    - configuration
    - slackware
- name: Configure certbot to use 4096 bit keys
  tags: pki
  become: true
  block:
    - name: Check for /etc/letsencrypt
      ansible.builtin.stat:
        path: /etc/letsencrypt
      register: stat_result
    # https://certbot.eff.org/docs/using.html
    - name: Configure /etc/letsencrypt/cli.ini
      community.general.ini_file:
        path: /etc/letsencrypt/cli.ini
        section: null
        option: rsa-key-size
        value: 4096
        mode: '0600'
      when: stat_result.stat.exists
      tags: configuration
- name: Configure /etc/krb5.conf
  tags:
    - configuration
    - kerberos
    - permissions
  community.general.ini_file:
    path: /etc/krb5.conf
    section: libdefaults
    option: '{{ item.key }}'
    value: '{{ item.value }}'
    owner: root
    group: root
    mode: '0644'
  become: true
  with_dict:
    verify_ap_req_nofail: "true"
    allow_weak_crypto: "false"
    default_tgs_enctypes: aes256-cts-hmac-sha384-192 aes256-cts-hmac-sha1-96
    default_tkt_enctypes: aes256-cts-hmac-sha384-192 aes256-cts-hmac-sha1-96
    ignore_acceptor_hostname: "false"
    clockskew: 300
    # https://web.mit.edu/kerberos/krb5-current/doc/admin/spake.html#spake
    spake_preauth_groups: edwards25519
# These are packages that ship SUID/SGID binaries, pam.d configurations, services or similar stuff that provides unnecessary attack surface
# Slackware Linux Benchmark v1.1:
#   * SN.5 Evaluate Packages Associated With Startup Scripts
#   * 7.1 Disable rhosts Support
# system-hardening-10.2.txt: Misc Stuff -> Stuff to remove
#
# Consider removing some of these packages as they were part of the most patched ones in Slackware 14.2
# Parsed with: sed -n 's/^patches\/packages\/\(.\+\)-.\+-.\+-.\+\.t.z: .*$/\1/p' ChangeLog.txt | sort | uniq -c | sort -g
#   * bind
#   * seamonkey
#   * seamonkey-solibs
#   * samba
#   * httpd & php
#   * mariadb
- name: Remove stuff
  become: true
  tags: slackware
  when: ansible_distribution == "Slackware"
  block:
    - name: Remove unneeded/unwanted packages (Slackware)
      community.general.slackpkg:
        name: '{{ item }}'
        state: absent
      with_items:
        - netkit-rsh
        - uucp
        - floppy
        - netatalk
        - slrn
        - yptools
        # libmm-glib.so is required by nm-applet
        #- ModemManager
        - modemmanager-qt
        - inetd
      tags: packages
    - name: Remove leftover files from removed packages
      ansible.builtin.file:
        path: '{{ item }}'
        state: absent
      with_items:
        - /etc/pam.d/netatalk
        - /etc/rc.d/rc.atalk
        - /etc/rc.d/rc.inetd
        - /etc/inetd.conf
#- name: Download checksec into /usr/local/bin
#  become: true
#  ansible.builtin.get_url:
#    url: https://www.trapkit.de/tools/checksec/checksec.sh
#    dest: /usr/local/bin/checksec.sh
#    owner: root
#    group: root
#    mode: '0755'
#    checksum: sha256:77b8a7fd9393d10def665658a41176ee745d5c7969a4a0f43cefcc8a4cd90947
- name: Set USB authorized_default -> 0 in /etc/rc.local (Debian)
  become: true
  ansible.builtin.blockinfile:
    path: /etc/rc.local
    marker: "# {mark} ANSIBLE MANAGED BLOCK - USB authorized_default"
    insertbefore: '^exit 0$'
    block: |
      /bin/bash -c 'shopt -s nullglob; for host in /sys/bus/usb/devices/usb*; do echo 0 1>"${host}/authorized_default"; done'
  when: ansible_distribution == "Debian" or ansible_distribution == "Kali GNU/Linux"
  tags:
    - configuration
    - debian
- name: Docker
  tags: docker
  block:
    - name: Stat /etc/docker
      ansible.builtin.stat:
        path: /etc/docker
      register: docker
    - name: Create /etc/docker/daemon.json
      become: true
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        force: false
        owner: root
        group: root
        mode: '0600'
        content: |
          {
            "experimental": false,
            "icc": false,
            "insecure-registries": [],
            "no-new-privileges": true
          }
      when: docker.stat.exists

- name: GNOME tracker
  tags:
    - configuration
    - gnome
    - services
  block:
    - name: Stat /etc/xdg/autostart/tracker-miner-fs.desktop
      ansible.builtin.stat:
        path: '/etc/xdg/autostart/tracker-miner-fs.desktop'
      register: stat
    - name: Disable tracker-miner-fs XDG autostart
      become: true
      ansible.builtin.lineinfile:
        path: '/etc/xdg/autostart/tracker-miner-fs.desktop'
        regexp: '^Hidden=true$'
        line: Hidden=true
        create: false
      when: stat.stat.exists
    - name: Stat /etc/xdg/autostart/tracker-extract.desktop
      ansible.builtin.stat:
        path: '/etc/xdg/autostart/tracker-extract.desktop'
      register: stat
    - name: Disable tracker-miner-fs XDG autostart
      become: true
      ansible.builtin.lineinfile:
        path: '/etc/xdg/autostart/tracker-extract.desktop'
        regexp: '^Hidden=true$'
        line: Hidden=true
        create: false
      when: stat.stat.exists
    - name: Disable tracker-miner-fs systemd unit
      ansible.builtin.systemd:
        name: tracker-miner-fs
        enabled: false
        state: stopped
        scope: user
      when: ansible_distribution == "Debian" or ansible_distribution == "Kali"
      tags:
        - debian

- name: php.ini
  tags:
    - php
    - configuration
  block:
    - name: Stat /etc/php.ini
      ansible.builtin.stat:
        path: /etc/php.ini
      register: stat_result
    # https://cheatsheetseries.owasp.org/cheatsheets/PHP_Configuration_Cheat_Sheet.html
    # TODO: Moar content!
    - name: Configure php.ini
      become: true
      when: stat_result.stat.exists
      community.general.ini_file:
        path: /etc/php.ini
        section: PHP
        option: expose_php
        value: 'Off'
        owner: root
        group: root
        mode: '0644'
